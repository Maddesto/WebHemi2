#!/bin/bash

# Define global variables
project_root="$(git rev-parse --show-toplevel)"
module_path="wh_application/module/WebHemi2"
file_names_to_check="$(git diff --cached --name-only --diff-filter=ACM  | egrep '*.(php|phtml)')"
BOLD=$(tput bold)
UNDERLINE=$(tput smul)
RED=$(tput setaf 1)
GREEN=$(tput setaf 2)
YELLOW=$(tput bold;tput setaf 3)
MAGENTA=$(tput bold;tput setaf 5)
ERROR=$(tput bold;tput setb 4)
NORMAL=$(tput sgr0)

# Check PHP Syntax Errors Before Committing
function check_lint()
{
    echo -e "\n$MAGENTA  Check for PHP Syntax errors $NORMAL"
    echo "$file_names_to_check" | while read FILE; do
        if [[ "$FILE" =~ ^.+\.(php|phtml)$ ]]; then
            # Courtesy of swytsh from the comments below.
            if [[ -f $FILE ]]; then
                tmp=$(php -l "$FILE" 2>&1)
                if [ $? -ne 0 ]; then
                    print_check_fail "$FILE"
                else
                    print_check_good "$FILE"
                fi
            fi
        fi
    done

    check_errors "Aborting commit due to files with syntax errors."
}

# Run PHPUnit tests
function run_unit_tests()
{
    echo -e "\n$MAGENTA  Run PHPUnit tests $NORMAL"

    # Get only the module files
    local module_files="$(echo -e "$file_names_to_check" | egrep "$module_path")"
    # Generate the UnitTest pair of the changed file
    local test_files="$(echo -e "$module_files" | sed 's/src\/WebHemi2\//test\/WebHemi2Test\//' | sed 's/.php/Test.php/')"
    # Go through the file list and check if the UnitTest exists. If so then run the test
    echo "$test_files" | while read FILE; do
    if [[ -f "$FILE" ]]; then
        output="$($project_root/wh_application/vendor/phpunit/phpunit/phpunit -c "$project_root/$module_path/test/phpunit_nolog.xml" "$FILE" 2>&1)"
        if [ $? -ne 0 ]; then
            print_check_fail "$FILE" "$output"
        else
            print_check_good "$FILE" "$output"
        fi
    fi
    done


    check_errors "Aborting commit due some PHPUnit test failed."
}

# Print stylish [OK]
#
# @param string $1 The message on the left side
function print_check_good()
{
    correcture=""
    local result="$(echo "$2" | egrep "^OK")"
    local msg="$1"
    if [ -n "$result" ];then
        msg="$msg - $GREEN$result$NORMAL"
        correcture="+ 11"
    fi
    local col=`expr $(tput cols) - ${#msg} $correcture`

    echo -en "    $msg"
    printf '%*s%s' $col "  [$GREEN OK $NORMAL]"
    # Make sure it's reseted
    echo "$NORMAL"
}

# Print stylish [FAIL]
#
# @param string $1 The message on the left side
function print_check_fail()
{
    # Set commit blocker
    touch /tmp/block.git.commit

    correcture="- 3"
    local result="$(echo "$2" | egrep "(^Tests: |^Failed |_Exception: |^[0-9])")"
    local msg="$1"
    local col=`expr $(tput cols) - ${#msg} $correcture`

    echo -en "    $ERROR!$NORMAL$YELLOW $msg $NORMAL"
    printf '%*s%s' $col "  [$RED FAIL $NORMAL]"
    # Make sure it's reseted
    echo "$NORMAL"

    if [ -n "$result" ];then
        result="$(echo -e "$result" | sed 's/^/       &/g' | sed 's/^       [A-Z]/   &/g')"
        echo "$result"
    fi
}

# Checks if there were errors and exit
#
# @param string $1 The message to print when abort the commit
function check_errors()
{
    local msg="$1"

    if [ -f /tmp/block.git.commit ]; then
        echo -en "\n$ERROR ERROR: $msg " >&2
        echo -e "$NORMAL\n"
        exit 1
    fi
}

# Prepare environment
function init()
{
    echo -e "\n$MAGENTA  Prepare environment $NORMAL"

    # Do cleanup
    if [ -f /tmp/block.git.commit ]; then
        local msg="Delete lock file..."
        local tmp=$(rm -f /tmp/block.git.commit 2>&1)
        if [[ $? -ne 0 ]];then
            print_check_fail "$msg"
        else
            print_check_good "$msg"
        fi

        check_errors "Aborting commit. Cannot remove file /tmp/block.git.commit Permission denied."
    fi

    # Just a message for what we already done
    print_check_good "Collect changed PHP files..."
}

# Main task
function main()
{
    # Quit if the commit is not executed from shell (but from some nested shells within an IDE)
    if [[ $SHLVL -lt "2" ]]; then
        exit;
    fi

    # Quit if there are no PHP files to commit
    if [[ ! -n $file_names_to_check ]];then
        exit;
    fi

    clear
    echo -e "$YELLOW \bStarting pre-commit hooks. $NORMAL"

    # Run tasks
    init
    check_lint
    run_unit_tests
}

main
echo -e "$NORMAL"
